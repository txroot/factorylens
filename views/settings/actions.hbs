{% extends "layouts/dash.hbs" %}

{% block content %}
<h2 class="mt-4 fw-bold">{{ _('Actions') }}</h2>

{% if not agent_ok %}
  <!-- Empty‑state – no Action Agent device -->
  <section class="d-flex flex-column align-items-center justify-content-center" style="height:460px">
    <img src="{{ url_for('static', filename='img/actions/undraw_accept-tasks.svg') }}"
         class="mb-4" style="max-width:260px" alt="">
    <h4 class="text-secondary mb-2">{{ _('No actions configured') }}</h4>
    <p class="text-muted text-center" style="max-width:420px">
      {{ _('You need to add & enable an “Action Agent” device first.') }}<br>
      <a href="{{ url_for('settings.devices_page') }}" class="fw-semibold">{{ _('Open Device Manager') }}</a>
    </p>
  </section>

{% else %}
  <p class="mb-3 text-muted">
    {{ _('Create simple <strong>IF → THEN</strong> rules that react to device events.')}} <br>
    {{ _('All comparisons & valid payloads are auto‑suggested from each device model.')|safe }}
  </p>

  <div class="d-flex justify-content-end mb-2">
    <button id="addActionBtn" class="btn btn-primary">
      <i class="ti ti-plus"></i> {{ _('New Action') }}
    </button>
  </div>

  <div class="table-responsive">
    <table id="actionsTable" class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>{{ _('Name') }}</th>
          <th style="width:35%">{{ _('Description') }}</th>
          <th class="text-center">{{ _('Enabled') }}</th>
          <th style="width:100px"></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ─── Action Builder ────────────────────────────────────────── -->
  <div class="modal fade" id="actionModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><span id="modalTitle">{{ _('New Action') }}</span></h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <form id="actionForm" class="needs-validation" novalidate>
          <div class="modal-body">
            <div class="row g-3">

              <!-- name & description -->
              <div class="col-12">
                <label class="form-label">{{ _('Name') }} *</label>
                <input name="name" class="form-control" required>
                <div class="invalid-feedback">{{ _('Required') }}</div>
              </div>

              <div class="col-12">
                <label class="form-label">{{ _('Description') }}</label>
                <textarea name="description" class="form-control" rows="2"></textarea>
              </div>

              <!-- ── Trigger row ── -->
              <div class="col-12">
                <h6 class="mt-2 mb-1">{{ _('IF (device event)') }}</h6>
              </div>

              <div class="col-md-4">
                <label class="form-label">{{ _('Device') }} *</label>
                <select name="trigger_device" class="form-select" required></select>
              </div>

              <div class="col-md-4">
                <label class="form-label">{{ _('Topic / Channel') }} *</label>
                <select name="trigger_topic" class="form-select" required disabled></select>
              </div>

              <div class="col-md-2 d-none" id="triggerCmpCol">
                <label class="form-label">{{ _('Cmp.') }}</label>
                <select name="trigger_cmp" class="form-select"></select>
              </div>

              <div class="col-md-2" id="triggerValCol">
                <label class="form-label">{{ _('Value') }} *</label>
                <!-- will be replaced by <select> when enum -->
                <input name="trigger_value" class="form-control" required disabled>
              </div>

              <!-- ── Result row ── -->
              <div class="col-12 pt-2">
                <h6 class="mb-1">{{ _('THEN (send command)') }}</h6>
              </div>

              <div class="col-md-4">
                <label class="form-label">{{ _('Device') }} *</label>
                <select name="result_device" class="form-select" required></select>
              </div>

              <div class="col-md-4">
                <label class="form-label">{{ _('Topic / Channel') }} *</label>
                <select name="result_topic" class="form-select" required disabled></select>
              </div>

              <div class="col-md-4" id="resultCmdCol">
                <label class="form-label">{{ _('Command / Payload') }} *</label>
                <input name="result_command" class="form-control" required disabled>
              </div>

              <!-- enabled toggle -->
              <div class="col-12 form-switch mt-3">
                <input class="form-check-input" type="checkbox" id="enabledChk" name="enabled" checked>
                <label class="form-check-label" for="enabledChk">{{ _('Enabled') }}</label>
              </div>

            </div><!-- /row -->
          </div><!-- /modal‑body -->

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
            <button id="saveActionBtn" class="btn btn-primary">{{ _('Save') }}</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/settings/actions.js') }}"></script>
{% endblock %}
