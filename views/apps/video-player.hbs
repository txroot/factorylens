{% extends "layouts/dash.hbs" %}

{% block content %}
<h2 class="mt-4">{{ gettext("video_player_title") }}</h2>
<p class="mb-4">{{ gettext("video_player_description") }}</p>

<div class="row">
  {% for cam in cameras %}
  <div class="col-md-4 mb-4 d-flex align-items-stretch">
    <div class="card w-100">
      <!-- Title -->
      <div class="card-header text-center">
        <h5 class="mb-0">{{ cam.name }}</h5>
      </div>

      <!-- Snapshot + loader (16 × 9 box, max‑300 px) -->
      <div class="p-3 d-flex justify-content-center">
        <div class="ratio ratio-16x9 position-relative" style="max-width:300px;width:100%;">
          <div id="spinner-{{ cam.id }}"
               class="position-absolute top-0 start-0 w-100 h-100 d-flex
                      justify-content-center align-items-center bg-light">
            <div class="spinner-border text-primary"></div>
          </div>

          <img src="{{ url_for('apps.video_snapshot', cam_id=cam.id) }}"
               alt="{{ cam.name }} snapshot"
               class="position-absolute top-0 start-0 w-100 h-100 snapshot-img"
               data-cam-id="{{ cam.id }}"
               style="object-fit:cover;">
        </div>
      </div>

      <!-- Action buttons -->
      <div class="card-body text-center">
        <!-- play -->
        <button class="btn btn-primary play-btn me-2"
                data-cam-id="{{ cam.id }}"
                data-stream-url="{{ cam.stream_url }}"
                data-bs-toggle="modal"
                data-bs-target="#videoModal">
          <i class="ti ti-player-play"></i>
        </button>

        <!-- snapshot refresh -->
        <button class="btn btn-info snapshot-btn me-2" data-cam-id="{{ cam.id }}">
          <i class="ti ti-camera"></i>
        </button>

        <!-- “check url” -> popover (html enabled) -->
        <button class="btn btn-secondary url-popover me-2"
                data-url="{{ cam.stream_url }}">
          <i class="ti ti-link"></i>
        </button>

        <!-- open externally -->
        <a href="{{ cam.stream_url }}" target="_blank" class="btn btn-outline-secondary me-2">
          <i class="ti ti-external-link"></i>
        </a>

        <!-- tiny spinner while backend starts ffmpeg -->
        <div class="spinner-border spinner-border-sm text-primary ms-2 d-none"></div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- video modal -->
<div class="modal fade" id="videoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ gettext("video_player_title") }}</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0">
        <video id="modal-video" class="w-100" muted controls playsinline style="background:#000;"></video>
      </div>
    </div>
  </div>
</div>

<!-- snapshot preview modal -->
<div class="modal fade" id="snapshotModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ gettext("snapshot_title") }}</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="snapshot-img" class="img-fluid" style="max-width:100%;" alt="{{ gettext('snapshot') }}">
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Bootstrap bundle (popper included) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- hls.js -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<!-- page logic -->
<script src="{{ url_for('static', filename='js/apps/video-player.js') }}"></script>
{% endblock %}
